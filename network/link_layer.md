# Link Layer（以太网）



## 一、链路层的主要功能

链路层所要提供的基本服务是将数据报通过单一的通信链路从一个节点移动到**相邻节点**。这说明，链路层只能完成短距离的数据传输。

链路层还提供了其他一些可选服务：

- 成帧；
- 链路接入控制（MAC）；
- 检错和纠错（CRC）；
- 可靠交付（常用于高出错率的信道）；



## 二、几个观点

- 链路层处于网络层的下方，即在链路层看来，网络层的信息是透明的，因此，**链路层无法处理 IP 地址**。
- 计算机网络是根据 IP 地址来划分子网的，若链路层无法处理 IP 地址，则仅靠链路层是无法将数据转发到子网外的。



## 三、链路层的工作方式

​	在网络边缘和网络核心中，链路层的工作方式不太一样。在前者中，链路层的主要功能是构造和解析链路层帧，这需要我们填入或去除相关字段；在后者中，链路层的主要功能是转发数据帧，不进行构造和解析活动。

### 1、网络边缘中设备的链路层的工作方式（ARP）

#### 1.1、编址

​	链路层无法识别 IP 地址，它通过 MAC 地址来区分设备。

​	MAC （Medium Access Control）地址用于区分主机或路由器的网络适配器，一台主机可能有几个适配器，每个适配器有不同的 MAC 地址。

​	MAC 地址由6个字节组成，是一成不变的，独一无二的。

#### 1.2、寻址

- ARP（Address Resolution Protocol）协议

    当链路层之间进行通信时，我们需要知道目的地的链路层地址（MAC），但网络层传递过来的数据中未包含这个信息，我们如何获得这个 MAC 地址呢？通过ARP协议模块，这个模块取在相同局域网上的任何 IP 地址作为输入，然后返回相应的 MAC 地址。每个网络适配器都有自己的ARP模块。

- 寻址过程

    - 以目的 IP 作为输入，查询本地的 ARP 表
        - 查到，将对应的 MAC 地址封装进链路层帧中，发送。
        - 未查到，ARP模块解析IP地址，构造一个 ARP分组 （源 IP，目的 IP，源 MAC，广播 MAC），封装进一个链路层帧中，向子网发送这个帧。子网内的每一台适配器的 ARP 模块将 目的IP 和自己的 IP 地址进行匹配。
    - 匹配成功，构造一个 ARP 分组（源 IP，目的 IP，源 MAC，目的 MAC）,封装进一个链路层帧中，发送。
    - 更新 ARP 表，将 IP 数据报和 源MAC ，目的MAC地址一起封装进链路层帧中发送。

- 在寻址之前，要先判断 目的IP 和 源IP 是否在同一个子网中，若在，本地ARP模块直接解析 目的IP ；若二者不在同一个子网内，本地ARP模块解析的是 网关的IP，即先将数据传输到网关那里。



### 2、网络核心中设备的链路层的工作方式（链路层交换机）

#### 2.1、链路层交换机

- 交换机自身对于子网中的主机和路由器是透明的。
- 根据交换机表来完成过滤和转发功能。
- 交换机是自学习的，即插即用的，全双工的。

#### 2.2、过滤

决定一个帧应该转发到某个接口还是应当将其丢弃的功能。

#### 2.3、转发

决定一个帧应该被导向哪个接口，并把该帧移动到那些接口的功能。以交换机表为依据，在转发的过程中可能会遇到三种情况：

- 表中没有相应的项，交换机向除接受端口之外的所有端口广播该帧。
- 表中有相应的项，但输出端口与接受端口一致，过滤该帧。
- 表中有相应的项且输出端口和接受端口不一致，将帧放在输出端口后的缓存队列中。



### 3、完整的端到端的链路层数据传输例子



## 四、补充

### 1、链路的类型

- 点对点链路：由链路一端的单个发送方和链路另一端的单个接收方组成。（PPP，HDLC）
- 广播链路：让多个发送和接受节点都连接到相同的，单一的，共享的广播信道上，一般用于组建局域网（以太网和无线局域网），需要使用 MAC协议 来协调帧的传输。



### 2、广播链路的问题和解决方案

- 多路访问问题：因为碰撞的存在，如何协调多个发送和接受节点对一个共享广播信道的访问？
- 多路访问协议：规范节点在共享的广播信道上传输行为的一系列链路层协议。
    - 信道划分协议：
        - TDM：
        - FDM：
        - CDMA：
    - 随机接入协议：
        - ALOHA协议：
        - CSMA协议：（以太网协议）
    - 轮流协议：



### 3、一种具体的广播链路网络 --- 以太网

- 以太网是一种广播链路网，它使用的以太网协议是一种 CSMA 协议。
- 以太网帧的结构：
- 以太网结构：集线器（会产生碰撞） ---> 交换机（不会产生碰撞）
- 以太网技术提供无连接的，不可靠的数据传输服务。
- 现代以太网因为使用交换机替代集线器而消除了碰撞，因此，似乎可以不在使用以太网协议了，但出于别的考虑，初始的以太网MAC协议和帧的格式保留了下来。



### 4、链路层为什么要使用MAC地址（为什么要使用链路层交换机）？

​	在现代以太网中，

