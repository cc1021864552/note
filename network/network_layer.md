# Network Layer

## 一、网络层提供的服务

网络层提供的服务是将分组从一台主机移动到另一台主机。为此，需要实现两种功能：

- 转发
- 路由选择



## 二、几个观点

- 从网络组成的角度看，网络中的设备的 “身份证号码” 是 IP 地址，网络核心中没有链路层的交换机。
- 从确定数据传输路径的方式看，路由选择的算法大致有两种：
    - 全局的，每台路由器需要知道网络中其余所有路由器的信息，这样，问题蜕变成了图论中的最短路径问题。
    - 分布式的，每台路由器不需要知道所有路由器的信息，只需知道相邻的路由器的信息，以此来确定路由，这样，问题有了明显的动态规划特性。
- 从网络规模的角度看，当网络规模不大时，网络的复杂程度不高时，路由器使用统一的路由计算方式是可行的。但当网络的规模变得很大（如因特网），让所有的路由器使用同样的路由计算方式（不管是全局的还是分布式的），将会使得获取信息的开销变得非常大，且不一定算的出来，不可取。因此，需要减小网络的规模，让小规模网络使用自己的路由计算方式，网络和网络之间使用共同的路由计算方式。



## 三、网络层的工作方式

### 3.1、网络边缘中网络层的工作方式

#### 3.1.1、获取 IP 地址

- IPv4
    - 4个字节，按点分十进制记法书写，例如：192.168.10.1/24 .
    - 一个 IP 地址和一个接口相关联，而不是与包括该接口的主机或路由器相连。
    - IP 地址由子网号和主机号共同决定（CIDR），子网号占IP地址的位数有子网掩码决定（/24）。
    - 不同子网的子网号可能有部分相同的前缀，这时，按照最长前缀匹配原则确定目标子网号。
- DHCP（Dynamic Host Configure Protocol）
    - 作用：向子网的DHCP服务器申请一个临时IP地址，分配给主机。主机还可以获取子网掩码，默认网关，本地DNS服务器的地址。
    - 申请流程：
        - 新到达的主机发送 DHCP发现报文 来发现DHCP服务器。DHCP发现报文使用UDP传输层协议，目的IP为255.255.255.255，目的端口号为67，源IP为0.0.0.0，源端口号为 68，交付给链路层。
        - DHCP服务器提供选项，DHCP提供报文格式：目的IP 为255.255.255.255，目的端口为68，源IP为DHCP服务器的IP，源端口为67，数据段为可选的IP地址和其他参数，交付给链路层。
        - 主机选择IP地址，发送DHCP请求报文，申请该IP地址，在该阶段，主机还没有IP地址。
        - DHCP服务器确认，DHCP服务器发送DHCP ACK报文证实申请的参数，此时，主机才分配到了IP地址。

#### 3.1.2、发送数据

​	将IP数据报打包交付给链路层。



### 3.2、网络核心中网络层的工作方式（路由器的工作方式）

#### 3.2.0、设置端口IP

​	见上述过程。

#### 3.2.1、接受数据

- 输入端口排队
- 根据路由表选择输出端口：最长匹配前缀原则
- 经交换结构将数据传输到输出端口：
    - 经总线交换
    - 经内存交换
    - 经互联网络交换

#### 3.2.2、输出数据

- 输出排队调度
    - FIFO排队
    - 优先权排队
    - 循环和加权公平排队

#### 3.2.3、路由表的设置（路由算法）

- 从算法思想的角度：
    - Dijkstra：链路状态算法，全局的，集中式和分布式都行。
    - Distance-Vector：分布式，迭代，异步算法。
        - 当链路开销增加时，会出现路由选择环路问题和无穷计数问题。
        - 增加毒性逆转可以解决部分的无穷计数问题。
- 从网络规模的角度：
    - 自治系统内部的路由选择（OSPF）：基于 Dijkstra 算法，一般只处理到网关路由器的路径。
    - 自治系统间路由选择（BGP）：基于 DV 算法，处理AS间的路径。
        - 从邻居 AS 获得前缀的可达性信息（BGP属性）：向互联网的其他部分告知自己的地址。
            - AS-PATH：AS路径
            - NEXT-HOP：AS-PATH起始的路由器接口的 IP 地址
            - 目的前缀
        - 确定到达该前缀的最好的路由：基于路由选择策略来决定路由。
            - 热土豆路由选择：贪心策略
            - 最短 AS-PATH 路由选择；
- 一个完整的 AS 的构建和工作过程：



## 四、通用转发（中间盒技术）

​	上述的路由器转发过程称为基于目的地的转发，其实，抽象地看，可以将这种转发分为两步：匹配+动作。通用转发就是使用不同的方式实现这两步的过程，通过通用转发，可以以一种现代的，简洁的，综合的方式来提供多种网络层和链路层的功能。下面是几种具体的例子：

### 4.1、NAT（Network Address Translation）

- 作用：对外部掩藏网络内部的细节，代理网络内部的主机向外发送数据，或向内发送数据。
- 原理：利用 NAT表（WAN端，LAN端） 将IP地址和端口号进行转换，然后在进行转发。
- 应用：NAT称为了一种网络层中间盒，并不执行传统的数据转发功能，而是执行如NAT，防火墙，负载均衡等功能。 

### 4.2、防火墙

### 4.3、负载均衡器

### 4.4、深度分组检测（DPI）



## 五、其他协议

### 5.1、ICMP



### 5.2、SNMP和网络管理

